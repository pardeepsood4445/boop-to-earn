<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=390, initial-scale=1.0" />
    <title>Boop To Earn</title>

    <!-- Farcaster Metadata -->
    <meta name="fc:frame" content='{
      "version": "1",
      "imageUrl": "https://boop-to-earn.vercel.app/image.png",
      "button": {
        "title": "Claim Boop",
        "action": {
          "type": "launch_frame",
          "name": "BoopToEarn",
          "url": "https://boop-to-earn.vercel.app",
          "splashImageUrl": "https://boop-to-earn.vercel.app/splash.png",
          "splashBackgroundColor": "#00BFFF"
        }
      }
    }' />

    <style>
      body {
        margin: 0;
        background: #00BFFF;
        color: white;
        font-family: sans-serif;
        text-align: center;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        min-height: 100vh;
      }

      .boop-image {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        cursor: pointer;
        margin: 12px 0;
      }

      .counter {
        font-size: 1.2rem;
        margin: 8px 0;
        max-width: 90%;
        word-break: break-word;
      }

      .connect-btn {
        background: white;
        color: black;
        font-weight: bold;
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        margin-top: 12px;
        cursor: pointer;
      }

      .connect-btn:disabled {
        background: #999;
        cursor: not-allowed;
      }

      /* ‚úÖ Toast Styles */
      #statusMessage {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 18px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 14px;
        display: none;
        z-index: 9999;
        min-width: 220px;
        text-align: center;
      }

      .toast-success {
        background: #4CAF50;
        color: white;
      }
      .toast-error {
        background: #FF4D4D;
        color: white;
      }
      .toast-info {
        background: #333;
        color: white;
      }
    </style>
  </head>
  <body>
    <h2 class="counter" id="totalBoops">Total Boops: ...</h2>

    <img src="/doglogo.png" alt="Boop" class="boop-image" id="boopButton" />

    <h2 class="counter" id="totalTokens">Total Tokens: ...</h2>

    <button class="connect-btn" id="connectBtn">Connect Wallet</button>

    <!-- ‚úÖ Toast Message Container -->
    <div id="statusMessage"></div>

    <!-- SDK & Wagmi -->
    <script type="module">
      import {
        createConfig,
        connect,
        readContract,
        writeContract,
        http
      } from 'https://esm.sh/@wagmi/core@2.6.1'

      import { arbitrum } from 'https://esm.sh/@wagmi/core/chains'
      import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector@1.0.0'
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'

      sdk.actions.ready({ disableNativeGestures: true })

      const totalBoopsEl = document.getElementById("totalBoops")
      const totalTokensEl = document.getElementById("totalTokens")
      const boopBtn = document.getElementById("boopButton")
      const connectBtn = document.getElementById("connectBtn")
      const statusDiv = document.getElementById("statusMessage")

      // ‚úÖ Toast message helper
      function showMessage(msg, type = "info") {
        statusDiv.textContent = msg
        statusDiv.className = ""
        statusDiv.style.display = "block"
        if (type === "error") {
          statusDiv.classList.add("toast-error")
        } else if (type === "success") {
          statusDiv.classList.add("toast-success")
        } else {
          statusDiv.classList.add("toast-info")
        }
        setTimeout(() => {
          statusDiv.style.display = "none"
        }, 4000)
      }

      // ‚úÖ Wagmi Config
      const config = createConfig({
        chains: [arbitrum],
        transports: { [arbitrum.id]: http() },
        connectors: [farcasterMiniApp()]
      })

      let account

      async function updateStats() {
        const contract = await fetch('/contract.json').then(r => r.json())
        const { address, abi } = contract

        const [boops, tokens] = await Promise.all([
          readContract(config, { address, abi, functionName: 'totalBoops' }),
          readContract(config, { address, abi, functionName: 'totalTokensDistributed' })
        ])

        const tokensFormatted = (BigInt(tokens) / 10n ** 18n).toString()
        totalBoopsEl.textContent = `Total Boops: ${boops}`
        totalTokensEl.textContent = `Total Tokens: ${tokensFormatted}`
      }

      // ‚úÖ Connect Wallet
      connectBtn.addEventListener('click', async () => {
        try {
          const res = await connect(config, { connector: farcasterMiniApp() })
          account = res.accounts[0]
          connectBtn.textContent = `${account.slice(0, 6)}...${account.slice(-4)}`
          connectBtn.disabled = true
          showMessage("‚úÖ Wallet connected!", "success")
        } catch (e) {
          console.warn('Connect failed:', e)
          if (e.name === "UserRejectedRequestError") {
            showMessage("‚ùå Wallet connection rejected.", "error")
          } else {
            showMessage("‚ö†Ô∏è Failed to connect wallet.", "error")
          }
        }
      })

      // ‚úÖ Handle Boop Click
      boopBtn.addEventListener("click", async () => {
        if (!account) {
          showMessage("‚ö†Ô∏è Please connect wallet first.", "error")
          return
        }

        boopBtn.style.opacity = 0.5
        boopBtn.disabled = true

        try {
          const contract = await fetch('/contract.json').then(r => r.json())
          const { address, abi } = contract

          // ‚úÖ Pre-check contract state
          const paused = await readContract(config, {
            address,
            abi,
            functionName: 'paused'
          })

          if (paused) {
            showMessage("üö® Boops are paused right now.", "error")
            return
          }

          const remaining = await readContract(config, {
            address,
            abi,
            functionName: 'boopsRemaining',
            args: [account]
          })

          if (remaining === 0n) {
            showMessage("üö´ You‚Äôve reached your daily boop limit.", "error")
            return
          }

          // ‚úÖ Call boop (wallet auto-calculates gas)
          const txHash = await writeContract(config, {
            address,
            abi,
            functionName: 'boop',
            args: []
          })

          console.log("‚úÖ Booped!", txHash)
          await updateStats()
          showMessage("üéâ Boop successful!", "success")
        } catch (err) {
          console.warn("Boop failed", err)

          if (err.name === "UserRejectedRequestError" || err.message?.includes("User rejected the request")) {
            showMessage("‚ùå You rejected the transaction.", "error")
          } else if (err.message?.includes("insufficient funds") || err.message?.includes("gas")) {
            showMessage("‚õΩ Wallet says insufficient gas ‚Äî check ETH on Arbitrum.", "error")
          } else {
            showMessage("‚ö†Ô∏è Boop failed. Check console.", "error")
          }
        } finally {
          boopBtn.style.opacity = 1
          boopBtn.disabled = false
        }
      })

      await updateStats()
    </script>
  </body>
</html>
