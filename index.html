<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=390, initial-scale=1.0" />
    <title>Boop To Earn</title>

    <!-- Farcaster Mini App Metadata -->
    <meta name="fc:frame" content='{
      "version": "1",
      "imageUrl": "https://boop-to-earn.vercel.app/image.png",
      "button": {
        "title": "Claim Boop",
        "action": {
          "type": "launch_frame",
          "name": "BoopToEarn",
          "url": "https://boop-to-earn.vercel.app",
          "splashImageUrl": "https://boop-to-earn.vercel.app/splash.png",
          "splashBackgroundColor": "#00BFFF"
        }
      }
    }' />

    <style>
      body {
        margin: 0;
        background: #00BFFF;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        min-height: 100vh;
        padding: 24px 0;
        text-align: center;
      }

      h2 {
        margin: 0;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .boop-image {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        border: 4px solid white;
      }

      #popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        color: black;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
        text-align: center;
        z-index: 1000;
      }

      #popup button {
        margin-top: 10px;
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        background: #00BFFF;
        color: white;
      }

      .counter {
        margin: 12px 0;
      }
    </style>
  </head>
  <body>
    <h2 id="totalBoops" class="counter">Total Boops: ...</h2>

    <img src="/doglogo.png" alt="Dog Nose" class="boop-image" id="boopButton" />

    <h2 id="totalTokens" class="counter">Total Tokens: ...</h2>

    <div id="popup">
      <p>You Booped! ðŸŽ‰</p>
      <button onclick="shareBoop()">ðŸ“£ Share</button>
    </div>

    <!-- SDK & Wallet Logic -->
    <script type="module">
      import {
        createConfig,
        connect,
        readContract,
        writeContract,
        http
      } from 'https://esm.sh/@wagmi/core'

      import { arbitrum } from 'https://esm.sh/@wagmi/core/chains'
      import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector'
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'

      const totalBoopsEl = document.getElementById("totalBoops")
      const totalTokensEl = document.getElementById("totalTokens")
      const boopBtn = document.getElementById("boopButton")
      const popup = document.getElementById("popup")

      const config = createConfig({
        chains: [arbitrum],
        transports: { [arbitrum.id]: http() }
      })

      sdk.actions.ready({ disableNativeGestures: true })

      async function fetchStats() {
        const { address, abi } = await fetch('/contract.json').then(r => r.json())
        const [boops, tokens] = await Promise.all([
          readContract(config, { address, abi, functionName: 'totalBoops' }),
          readContract(config, { address, abi, functionName: 'totalTokensDistributed' })
        ])
        totalBoopsEl.innerText = `Total Boops: ${boops}`
        totalTokensEl.innerText = `Total Tokens: ${(tokens / 1e18).toFixed(2)}`
      }

      window.shareBoop = function () {
        const msg = "Did You Booped Yet? ðŸ‘ƒ https://boop-to-earn.vercel.app"
        sdk.actions.share({ text: msg })
      }

      boopBtn.addEventListener("click", async () => {
        boopBtn.style.opacity = 0.6

        try {
          await connect(config, { connector: farcasterMiniApp() })
          const { address, abi } = await fetch('/contract.json').then(r => r.json())

          await writeContract(config, {
            address,
            abi,
            functionName: 'boop',
            args: []
          })

          await fetchStats()
          popup.style.display = "block"
          setTimeout(() => (popup.style.display = "none"), 4000)
        } catch (err) {
          console.warn("Boop failed or rejected:", err.message)
          // Don't alert user for rejected txn
        } finally {
          boopBtn.style.opacity = 1
        }
      })

      fetchStats()
    </script>
  </body>
</html>