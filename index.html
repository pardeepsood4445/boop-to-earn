<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=390, initial-scale=1.0" />
    <title>Boop To Earn</title>

    <!-- Farcaster Mini App Metadata -->
    <meta name="fc:miniapp" content='{
      "version": "1",
      "imageUrl": "https://boop-to-earn.vercel.app/image.png",
      "button": {
        "title": "Claim Boop",
        "action": {
          "type": "launch_frame",
          "name": "BoopToEarn",
          "url": "https://boop-to-earn.vercel.app",
          "splashImageUrl": "https://boop-to-earn.vercel.app/splash.png",
          "splashBackgroundColor": "#00BFFF"
        }
      }
    }' />

    <style>
      body {
        margin: 0;
        background: #00BFFF;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        min-height: 100vh;
        padding: 16px;
        box-sizing: border-box;
        text-align: center;
      }

      .stats {
        width: 100%;
        max-width: 390px;
        display: flex;
        justify-content: space-between;
        font-size: 1rem;
        font-weight: bold;
        padding: 0 12px;
      }

      .boop-image {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        border: 4px solid white;
        margin: 20px 0;
      }

      .counter {
        font-size: 1.2rem;
        margin: 6px 0;
      }
    </style>
  </head>
  <body>
    <div class="stats">
      <div id="totalBoops">Total Boops: ...</div>
      <div id="totalUsers">Total Users: ...</div>
    </div>

    <img
      src="/doglogo.png"
      alt="Dog Nose"
      class="boop-image"
      id="boopButton"
    />

    <h2 id="totalTokens" class="counter">Boop Distributed: ...</h2>

    <script type="module">
      import {
        createConfig,
        connect,
        readContract,
        writeContract,
        http
      } from 'https://esm.sh/@wagmi/core';

      import { arbitrum } from 'https://esm.sh/@wagmi/core/chains';
      import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

      const config = createConfig({
        chains: [arbitrum],
        transports: {
          [arbitrum.id]: http("https://arb-mainnet.g.alchemy.com/v2/i7ecNZG-rCS5xKuc1GP6_ZSYkgCkBfcr")
        }
      });

      const fetchStats = async (config, address, abi) => {
        const [boops, tokens, users] = await Promise.all([
          readContract(config, { address, abi, functionName: 'totalBoops' }),
          readContract(config, { address, abi, functionName: 'totalTokensDistributed' }),
          readContract(config, { address, abi, functionName: 'totalUniqueUsers' })
        ]);

        document.getElementById("totalBoops").innerText = `Total Boops: ${boops}`;
        document.getElementById("totalTokens").innerText = `Boop Distributed: ${formatLargeNumber(tokens)}`;
        document.getElementById("totalUsers").innerText = `Total Users: ${users}`;
      };

      function formatLargeNumber(num) {
        const n = Number(num) / 1e18;
        if (n >= 1e6) return `${(n / 1e6).toFixed(1)}M`;
        if (n >= 1e3) return `${(n / 1e3).toFixed(1)}K`;
        return n.toFixed(2);
      }

      const startApp = async () => {
        try {
          await connect(config, { connector: farcasterMiniApp() });

          const { address, abi } = await fetch('/contract.json').then(r => r.json());

          document.getElementById("boopButton").addEventListener("click", async () => {
            const btn = document.getElementById("boopButton");
            btn.style.opacity = 0.5;
            try {
              const hash = await writeContract(config, {
                address,
                abi,
                functionName: 'boop'
              });
              console.log("Booped!", hash);
              await fetchStats(config, address, abi);
            } catch (err) {
              console.error("Boop failed or rejected", err);
            } finally {
              btn.style.opacity = 1;
            }
          });

          await fetchStats(config, address, abi);
          await sdk.wallet.getEthereumProvider();
          sdk.actions.ready({ disableNativeGestures: true });
        } catch (err) {
          console.warn("Initialization error:", err);
        }
      };

      startApp();
    </script>
  </body>
</html>
